# 2. 도메인 분석 설계
## 02. 도메인 모델과 테이블 설계
![image](https://github.com/GYUNGAEEEE/inflearn-SpringBoot-JPA/assets/158580466/a163b81b-d276-415e-8412-c2f98cb7000e)

- 회원, 주문, 상품의 관계

회원은 여러 상품을 주문할 수 있다.
그리고 한 번 주문할 때 여러 상품을 선택할 수 있고, 상품은 여러 주문에 담길 수 있으므로 주문과 상품은 다대다 관계다.

하지만 이런 다대다 관계는 관계형 데이터베이스는 물론이고 엔티티에서도 거의 사용하지 않는다.
따라서 그림처럼 주문상품이라는 엔티티를 추가해서 다대다 관계를 일대다, 다대일 관계로 풀어냈다.

한 번 주문을 할 때 배송 정보를 하나 입력하기 때문에 주문과 배송은 일대일 관계다.

- 상품 분류

상품은 도서, 음반, 영화로 구분되는데 상품이라는 공통 속성을 사용하므로 상속 구조로 표현했다.

그리고, 하나의 상품은 여러 카테고리에 속할 수 있고, 하나의 카테고리에는 여러 상품이 속할 수 있으므로 상품과 카테고리를 다대다 관계다.

***
### 회원 엔티티 분석
![image](https://github.com/GYUNGAEEEE/inflearn-SpringBoot-JPA/assets/158580466/cf070dd6-840a-492f-98af-1be50e9f2317)

- 회원(Member)

이름과 임베디드 타입인 주소(Address), 그리고 주문(orders) 리스트를 가진다.

- 주문(Order)

한 번 주문시 여러 상품을 주문할 수 있으므로 주문과 주문상품(OrderItem)은 일대다 관계다.
주문은 상품을 주문한 회원과 배송 정보, 주문 날짜, 주문 상태(status)를 가지고 있다.
주문 상태는 열거형을 사용했는데 주문(ORDER), 취소(CANCEL)을 표현할 수 있다.

- 주문상품(OrderItem)

주문한 상품 정보와 주문 금액(orderPrice), 주문 수량(count) 정보를 가지고 있다.(보통 OrderLine, LineItem 으로 많이 표현한다.)

- 상품(Item)

이름, 가격, 재고수량(stockQuantity)을 가지고 있다. 상품을 주문하면 재고수량이 줄어든다.
상품의 종류로는 도서, 음방, 영화가 있는데 각각은 사용하는 속성이 조금씩 다르다.

- 배송(Delivery)

주문시 하나의 배송 정보를 생성한다. 주문과 배송은 일대일 관계다.

- 카테고리(Category)

상품과 다대다 관계를 맺는다. parent, child로 부모, 자식 카테고리를 연결한다.

- 주소(Address)

값 타입(임베디드 타입)이다. 회원과 배송(Delivery)에서 사용한다.

> 실무에서 사용하기에 애매한, 풍성한 예제를 위해서 넣은 조건들이 존재한다.
> 카테고리와 상품의 다대다 관계는 실제로 일대다, 다대일로 풀어내는 것이 올바르며,
> 회원이 주문을 참조하는 것(회원이 주문 리스트를 갖고 있는 것)은 주문이 회원을 참조하는 것으로 충분하다.
> 실제로는 필터링 조건에 Member가 들어가게 조회하면 된다.

***
### 회원 테이블 분석
![image](https://github.com/GYUNGAEEEE/inflearn-SpringBoot-JPA/assets/158580466/ac175ffc-7a28-4e32-be06-a75110e26e8f)

- MEMBER

회원 엔티티의 Address 임베디드 타입 정보가 회원 테이블에 그대로 들어갔다.
이것은 DELIVERY 테이블도 마찬가지다.

- ITEM

앨범, 도서, 영화 타입을 통합해서 하나의 테이블로 만들었다.
DTYPE 컬럼으로 타입을 구분한다.

> 테이블명으로 관례상 ORDER 대신 ORDERS를 많이 사용하는데, 데이터베이스가 order by를 예약어로 잡고 있는 경우가 많기 때문이다.

> 데이터베이스 테이블명, 컬럼명에 대한 관례는 회사마다 다르다. 보통은 대문자 + _(언더스코어)나 소문자 + _(언더스코어) 방식 중에 하나를
> 지정해서 일관성 있게 사용한다.

***
### 연관관계 매핑 분석
- 회원과 주문

일대다, 다대일의 양방향 관계다. 따라서 연관관계의 주인을 정해야 하는데, 외래 키가 있는 주문을 연관 관계의 주인으로 정하는 것이 좋다.
그러므로 Order.member를 ORDERS.MEMBER_ID 외래 키와 매핑한다.

- 주문상품과 주문

다대일 양방향 관계다. 외래 키가 주문상품에 있으므로 주문상품이 연관관계의 주인이다.
그러므로 OrderItem.order를 ORDER_ITEM.ORDER_ID 외래 키와 매핑한다.

- 주문상품과 상품

다대일 단방향 관계다. OrderItem.item을 ORDER_ITEM.ITEM_ID 외래 키와 매핑한다.

- 주문과 배송

일대일 양방향 관계다. Order.delivery를 ORDERS.DELIVERY_ID 외래 키와 매핑한다.

- 카테고리와 상품

@ManyToMany를 사용해서 매핑한다.(실무에서 @ManyToMany는 사용하지 말자. 여기서는 다대다 관계를 예제로 보여주기 위해 추가했을 뿐이다.)

> 외래 키가 있는 곳을 연관관계의 주인으로 정해라.
>
> 연관관계의 주인은 단순히 외래 키를 누가 관리하냐의 문제이지 비즈니스상 우위에 있다고 주인으로 정하면 안된다.
> 일대다 관계에서 항상 다쪽에 외래 키가 있으므로 그를 연관관계의 주인으로 정하면 된다.
>
> 반대를 연관관계의 주인으로 정하는 것이 불가능한 것은 아니지만, 관리와 유지보수가 어렵고,
> 추가적으로 별도의 업데이트 쿼리가 발생하는 성능 문제도 있다.
